# 积分更新推送通知功能说明

## 功能概述

当用户查询过积分并启用了推送通知后，系统会定期检查用户的积分变化。如果积分有更新，会自动向用户发送推送通知提醒。

## 工作流程

1. **用户添加 Mini App 并启用通知**
   - 用户在 Farcaster 中添加 Mini App 时，Farcaster 客户端会发送 `miniapp_added` 事件到 `/api/webhook`
   - 用户在"Add to Farcaster"提示中勾选"Enable notifications"时，Farcaster 客户端会发送 `notifications_enabled` 事件
   - Webhook API 会保存用户的 `notificationToken` 和 `notificationUrl`

2. **用户查询积分**
   - 当用户查询自己的积分时，前端会调用 `/api/saveUserScore` 保存当前积分作为基准值
   - 这是为了在首次检查时不会发送通知（因为还没有历史记录）

3. **定时检查积分变化**
   - Vercel Cron Job 每 6 小时自动调用 `/api/checkScoreUpdates`
   - 该 API 会：
     - 遍历所有启用了通知的用户
     - 从 Neynar API 获取最新的积分
     - 与上次保存的积分进行比较
     - 如果积分有变化，向用户的 `notificationUrl` 发送推送通知

4. **用户收到通知**
   - 通知标题：`积分更新 🎉`
   - 通知内容：`您的积分已更新：{旧积分} → {新积分} ({变化量})`
   - 点击通知会打开 Mini App 并显示最新积分

## 文件说明

### 1. `/pages/api/webhook.ts`
- **功能**：接收 Farcaster 客户端发送的 webhook 事件
- **事件类型**：
  - `miniapp_added`: 用户添加 Mini App
  - `miniapp_removed`: 用户移除 Mini App
  - `notifications_enabled`: 用户启用通知
  - `notifications_disabled`: 用户禁用通知
- **存储**：当前使用内存存储（`userNotifications` 对象）

### 2. `/pages/api/checkScoreUpdates.ts`
- **功能**：检查所有用户的积分变化并发送通知
- **触发方式**：
  - Vercel Cron Job（每 6 小时）
  - 手动调用（需要认证 token）
- **处理逻辑**：
  - 遍历所有启用了通知的用户
  - 获取最新积分
  - 比较积分变化
  - 发送推送通知

### 3. `/pages/api/saveUserScore.ts`
- **功能**：保存用户的当前积分（作为基准值）
- **调用时机**：用户查询积分时由前端调用

### 4. `/public/.well-known/farcaster.json`
- **配置**：添加了 `webhookUrl` 字段，指向 `/api/webhook`

### 5. `/vercel.json`
- **配置**：添加了 Cron Job 配置，每 6 小时执行一次

## 配置要求

### 1. Vercel 环境变量（可选）

在 Vercel 项目设置中添加环境变量：
- `CRON_SECRET`: 用于保护 `/api/checkScoreUpdates` 端点（可选，但推荐）

### 2. 存储系统（重要）

**当前实现**：使用内存存储（`userNotifications` 对象）
- ⚠️ **限制**：在 Vercel Serverless Functions 中，每次冷启动都会重置数据
- ⚠️ **影响**：用户的通知设置和积分历史可能会丢失

**推荐升级方案**：

#### 方案 A: 使用 Vercel KV（推荐）
```typescript
// 安装依赖
npm install @vercel/kv

// 在 Vercel 项目设置中配置 KV 数据库
// 然后修改 webhook.ts 和 checkScoreUpdates.ts 使用 KV 存储
```

#### 方案 B: 使用数据库（PostgreSQL, MongoDB 等）
- 使用 Vercel Postgres、Supabase、MongoDB Atlas 等
- 修改 API 路由使用数据库存储

## 测试方法

### 1. 测试 Webhook（需要 Farcaster 客户端支持）
- 添加 Mini App 到 Farcaster
- 启用通知
- 检查 Vercel 函数日志，应该看到 webhook 事件

### 2. 手动测试积分检查
```bash
# 在浏览器中访问（需要设置 CRON_SECRET 环境变量）
https://your-app.vercel.app/api/checkScoreUpdates?token=your-secret-token
```

### 3. 测试通知发送
- 确保用户已启用通知
- 确保用户已查询过积分（有基准值）
- 等待积分变化或手动调用检查 API
- 检查 Farcaster 客户端是否收到通知

## 注意事项

1. **存储持久化**：当前使用内存存储，生产环境需要升级到持久化存储
2. **签名验证**：Webhook 事件应该验证签名以确保安全性（当前未实现）
3. **速率限制**：Farcaster 通知有速率限制（每 30 秒 1 条，每天 100 条）
4. **Cron Job 频率**：当前设置为每 6 小时检查一次，可根据需要调整
5. **错误处理**：确保处理 API 调用失败、网络错误等情况

## 后续优化建议

1. ✅ 实现持久化存储（Vercel KV 或数据库）
2. ✅ 添加 Webhook 签名验证
3. ✅ 添加通知发送失败重试机制
4. ✅ 添加用户通知偏好设置（如通知频率）
5. ✅ 添加通知历史记录
6. ✅ 优化 Cron Job 频率（根据用户活跃度动态调整）

## 相关文档

- [Farcaster Mini Apps 文档](https://miniapps.farcaster.xyz/docs/specification)
- [Vercel Cron Jobs 文档](https://vercel.com/docs/cron-jobs)
- [Vercel KV 文档](https://vercel.com/docs/storage/vercel-kv)
